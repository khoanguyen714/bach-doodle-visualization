<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Dataset</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="Exploring the Bach Doodle dataset">
    <link href="style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Work+Sans:400,700&display=swap" rel="stylesheet">
    <style>
      .horizontal h3 {
        padding: 0 14px;
      }
      button.toggle, button.play {
        border-top: 2px solid black;
        border-left: 2px solid black;
        border-right: 2px solid black;
        background: white;
      }
      button.toggle {
        min-width: 90px;
      }
      button.toggle:hover {
        opacity: 1 !important;
      }
      button.toggle:not(.active) {
        opacity: 0.5;
      }
      button.toggle.active {
        font-weight: bold;
      }
      table {
        font-size: inherit;
        font-family: inherit;
        width: 100%;
        margin-bottom: 24px;
      }
      table td:first-of-type {
        width: 170px;
      }
      table td:last-of-type {
        font-weight: bold;
        word-break: break-all;
      }
      .box {
        overflow: auto;
      }
      .circle {
        width: 40px;
        height: 40px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 50%;
        box-shadow: var(--small-shadow);
      }
      @media screen and (max-width: 700px) {
        .horizontal.left {
          width: 100%;
          justify-content: space-between;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="horizontal">
        <button class="menu-btn" aria-label="nav drawer button" onclick="document.body.classList.toggle('drawer-opened')">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        <a href="index.html">Bach Doodle Dataset</a>
      </div>

      <div class="menu">
        <div class="hide-from-toolbar">
          <a href="dataset.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h8v2H6zm10 0h2v2h-2zm-6-4h8v2h-8z"/></svg>       Explore the dataset
          </a>
          <a href="overall.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M12 7.13l.97 2.29.47 1.11 1.2.1 2.47.21-1.88 1.63-.91.79.27 1.18.56 2.41-2.12-1.28-1.03-.64-1.03.62-2.12 1.28.56-2.41.27-1.18-.91-.79-1.88-1.63 2.47-.21 1.2-.1.47-1.11.97-2.27M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z"/></svg>
            Explore the top overall melodies
          </a>
          <a href="world.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95c-.32-1.25-.78-2.45-1.38-3.56 1.84.63 3.37 1.91 4.33 3.56zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2 0 .68.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56-1.84-.63-3.37-1.9-4.33-3.56zm2.95-8H5.08c.96-1.66 2.49-2.93 4.33-3.56C8.81 5.55 8.35 6.75 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2 0-.68.07-1.35.16-2h4.68c.09.65.16 1.32.16 2 0 .68-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95c-.96 1.65-2.49 2.93-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2 0-.68-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"/></svg>
            Explore melodies around the world
          </a>
        </div>
          <a href="https://magenta.tensorflow.org/datasets" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
            Get the data
          </a>
          <a href="https://www.google.com/doodles/celebrating-johann-sebastian-bach" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>
            Play the game
          </a>
          <a target="_blank" href="https://twitter.com/intent/tweet?hashtags=madewithmagenta&text=What%20do%2024%20million%20melodies%20composed%20with%20the%20Bach%20Doodle%20look%20like%3F%20https%3A%2F%2Fmagenta.tensorflow.org%2Fdatasets">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
            Share
          </a>
        </div>
      </div>
    </header>

    <section>
      <h1>What does the <br><span class="accent primary">dataset</span> look like?</h1>
      <p>
        Of the more than 50 million requests to the doodle itself, the user contributed dataset contains
        over 21.6 million miniature compositions totaling 78.8 years spent composing.
        The compositions are split across 8.5 million sessions -- each session represents
        an anonymous user's interaction with the web app and may contain multiple data points.
        Below you can explore <b>100</b> different sessions from the dataset, and each of their harmonizations
      </p>
    </section>

    <section>
      <div class="horizontal left">
        <button class="accent secondary circle" onclick="prevSession()" aria-label="view previous session">&lt;</button>
        <h3>Session: <b id="activeSession"></b>/100</h3>
        <button class="accent secondary circle" onclick="nextSession()" aria-label="view next session">&gt;</button>
      </div>
      <div class="horizontal left">
        <button class="accent secondary circle" onclick="prevHarmonization()" aria-label="view previous harmonization">&lt;</button>
        <h3>Harmonization: <b id="activeHarmonization"></b>/<b id="harms"></b></h3>
        <button class="accent secondary circle" onclick="nextHarmonization()" aria-label="view next harmonization">&gt;</button>
      </div>
      <h3>Metadata</h3>
      <table class="box">
        <tbody>
          <tr>
            <td>Backend</td>
            <td id="backend"></td>
          </tr>
          <tr>
            <td>Loops Listened</td>
            <td id="loops"></td>
          </tr>
          <tr>
            <td>Session ID</td>
            <td id="sid"></td>
          </tr>
          <tr>
            <td>Country code</td>
            <td id="country"></td>
          </tr>
          <tr>
            <td>Composition time</td>
            <td id="comp"></td>
          </tr>
          <tr>
            <td>Feedback</td>
            <td id="feedback"></td>
          </tr>
          <tr>
            <td>Key Signature</td>
            <td id="keysig"></td>
          </tr>
        </tbody>
      </table>

      <div class="horizontal">
        <div>
          <button class="toggle active" onclick="viewInput()" id="btnViewInput">input</button>
          <button class="toggle" onclick="viewOutput()" id="btnViewOutput">output</button>
        </div>
        <button class="play" onclick="playOrPause()" id="btnPlay">play</button>
      </div>

      <div class="box">
        <svg id="visualizer"></svg>
      </div>
    </section>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.8.0"></script>
  <script src="common.js"></script>
  <script>
    let allData;
    let sessionIndex = 0;
    let harmIndex = 0;

    fetch(DATAPOINTS_URL).then(response => response.json()).then((data) => {
      allData = data;
      updateView();
    });

    function updateView() {
      let data = allData[sessionIndex];

      activeSession.textContent = sessionIndex + 1;
      activeHarmonization.textContent = harmIndex + 1;

      harms.textContent = data.length;
      const b = data[harmIndex]['backend']
      backend.textContent = b + ` (${b == 'r'?'TPU': 'tf.js'})`;
      loops.textContent = data[harmIndex]['loops_listened'];
      sid.textContent = data[harmIndex]['session_id'];
      country.textContent = data[harmIndex]['country'];
      comp.textContent = data[harmIndex]['composition_time'] + ' (ms)';
      const f = data[harmIndex]['feedback'];
      feedback.textContent = f + ` (${f===0?'poor':(f==1?'neutral':(f==2?'good':'no rating'))})`;
      keysig.textContent = data[harmIndex]['key_sig'];

      // TODO: check if we need this hack after fixing the dataset.json to jsonl
      data[harmIndex]['output_sequence'].notes.forEach(n => {
        n.quantizedStartStep = parseInt(n.quantizedStartStep || 0)
        n.quantizedEndStep = parseInt(n.quantizedEndStep);
      });
      data[harmIndex]['input_sequence'].notes.forEach(n => {
        n.quantizedStartStep = parseInt(n.quantizedStartStep || 0)
        n.quantizedEndStep = parseInt(n.quantizedEndStep);
      });

      // Ensure the two visualizers are the same height by making them
      // have the same note ranges.
      const outputSequence = data[harmIndex]['output_sequence'];
      const pitches = outputSequence.notes.map(n => n.pitch);
      minPitch = Math.min(...pitches);
      maxPitch = Math.max(...pitches);

      if (btnViewInput.classList.contains('active')) {
        viewInput();
      } else {
        viewOutput();
      }
    }

    function nextSession() {
      sessionIndex = Math.min(sessionIndex + 1, allData.length - 1);
      harmIndex = 0;
      updateView();
    }
    function prevSession() {
      sessionIndex = Math.max(sessionIndex - 1, 0);
      harmIndex = 0;
      updateView();
    }
    function nextHarmonization() {
      harmIndex = Math.min(harmIndex + 1, allData[sessionIndex].length - 1);
      updateView();
    }
    function prevHarmonization() {
      harmIndex = Math.max(harmIndex - 1, 0);
      updateView();
    }

    function viewInput() {
      const ns = allData[sessionIndex][harmIndex]['input_sequence'];
      ns.totalQuantizedSteps = parseInt(ns.totalQuantizedSteps);

      player.loadSamples(ns);
      visualizeNoteSequence(ns, 'visualizer', minPitch, maxPitch);
      btnViewInput.classList.add('active');
      btnViewOutput.classList.remove('active');
    }

    function viewOutput() {
      const ns = allData[sessionIndex][harmIndex]['output_sequence'];
      ns.totalQuantizedSteps = parseInt(ns.totalQuantizedSteps);
      player.loadSamples(ns);
      visualizeNoteSequence(ns, 'visualizer', minPitch, maxPitch);
      btnViewInput.classList.remove('active');
      btnViewOutput.classList.add('active');
    }

    function playOrPause() {
      if (player.isPlaying()) {
        player.stop();
        btnPlay.textContent = 'play';
      } else {
        const key = btnViewInput.classList.contains('active') ? 'input_sequence' : 'output_sequence';
        const ns = allData[sessionIndex][harmIndex][key];
        ns.totalQuantizedSteps = parseInt(ns.totalQuantizedSteps);
        ns.tempos[0].time = 0;
        player.start(ns).then(() => btnPlay.textContent = 'play');
        btnPlay.textContent = 'stop';
      }
    }
  </script>
</html>
