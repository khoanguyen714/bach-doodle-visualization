<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Overall repeated melodies</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="Exploring the Bach Doodle dataset">
    <link rel="preconnect" href="https://storage.googleapis.com">
    <link href="style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Work+Sans:400,700&display=swap" rel="stylesheet">
    <style>
      .explanation {
        position: absolute;
        width: 280px;
        left: calc(50% - 140px);
        top: 35%;
        text-align: center;
        pointer-events: none;
      }
      #percentage {
        font-size: 40px;
        font-weight: bold;
      }
      #statMelName {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="horizontal">
        <button class="menu-btn" aria-label="nav drawer button" onclick="document.body.classList.toggle('drawer-opened')">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        <a href="index.html">Bach Doodle Dataset</a>
      </div>

      <div class="menu">
        <div class="hide-from-toolbar">
          <a href="dataset.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h8v2H6zm10 0h2v2h-2zm-6-4h8v2h-8z"/></svg>       Explore the dataset
          </a>
          <a href="overall.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M12 7.13l.97 2.29.47 1.11 1.2.1 2.47.21-1.88 1.63-.91.79.27 1.18.56 2.41-2.12-1.28-1.03-.64-1.03.62-2.12 1.28.56-2.41.27-1.18-.91-.79-1.88-1.63 2.47-.21 1.2-.1.47-1.11.97-2.27M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z"/></svg>
            Explore the top overall melodies
          </a>
          <a href="world.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95c-.32-1.25-.78-2.45-1.38-3.56 1.84.63 3.37 1.91 4.33 3.56zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2 0 .68.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56-1.84-.63-3.37-1.9-4.33-3.56zm2.95-8H5.08c.96-1.66 2.49-2.93 4.33-3.56C8.81 5.55 8.35 6.75 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2 0-.68.07-1.35.16-2h4.68c.09.65.16 1.32.16 2 0 .68-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95c-.96 1.65-2.49 2.93-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2 0-.68-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"/></svg>
            Explore melodies around the world
          </a>
          <a href="unique.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M22 11h-4.17l3.24-3.24-1.41-1.42L15 11h-2V9l4.66-4.66-1.42-1.41L13 6.17V2h-2v4.17L7.76 2.93 6.34 4.34 11 9v2H9L4.34 6.34 2.93 7.76 6.17 11H2v2h4.17l-3.24 3.24 1.41 1.42L9 13h2v2l-4.66 4.66 1.42 1.41L11 17.83V22h2v-4.17l3.24 3.24 1.42-1.41L13 15v-2h2l4.66 4.66 1.41-1.42L17.83 13H22z"/><path fill="none" d="M0 0h24v24H0z"/></svg>
            Explore the most unique compositions
          </a>
        </div>
          <a href="https://magenta.tensorflow.org/datasets" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
            Get the data
          </a>
          <a href="https://www.google.com/doodles/celebrating-johann-sebastian-bach" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>
            Play the game
          </a>
          <a target="_blank" href="https://twitter.com/intent/tweet?hashtags=madewithmagenta&text=What%20do%2024%20million%20melodies%20composed%20with%20the%20Bach%20Doodle%20look%20like%3F%20https%3A%2F%2Fmagenta.tensorflow.org%2Fdatasets">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
            Share
          </a>
        </div>
      </div>
    </header>

    <section>
      <h1>A burst of compositions</h1>
      <p class="trivia">
        There were over <b>24 million</b> total sequences entered in the dataset,
        and we heard a lot of popular favourites! The doodle's presets
        ("Twinkle Twinkle Little Star", "Mary Had a Little Lamb" and
        Bach's "Tocatta and Fugue in D minor") were by far the most repeated
        sequences, but we found some surprising runner ups. Explore them below!
      </p>
    </section>

    <div class="center">
      <section>
        <h2>The shortest melodies</h2>
        <p>Out of the top <b>2000 most repeated melodies</b>, <b>1347</b> of
          them were actually just 4 notes long! Below is a chart of these
          melodies colored by  The darker the square,
          the more popular the melody. Hover over any of them to hear them.
        </p>
      </section>
      <svg id="short"></svg>
    </div>

    <div class="center">
      <section>
        <h2>The longest melodies</h2>
        <p>From the remaining melodies, <b>447</b> of them were at least 10
          notes long:
        </p>
      </section>
      <svg id="long"></svg>
    </div>

    <div class="center">
      <section>
        <h2>The hits</h2>
        <p>We've been labelling the melodies that we recognize! Here they are:
        </p>
      </section>
      <svg id="hits"></svg>
    </div>

    <div class="center">
      <section>
        <h2>Once more, with feeling!</h2>
        <p>A cool thing we noticed is that the dataset contains several <b>variations</b>
          of popular classics, like "Ode to Joy"
          (like this <a class="accent" href="#3800">full version</a>,
          <a class="accent" href="#3386">with a typo</a>,
          <a class="accent" href="#3207">a different typo</a>,
          <a class="accent" href="#1229">short and slow</a>
          ).
          Different people entered fewer or more notes
          from the same recognizable melody, or got some of the notes wrong.
          In the visualization below, we are looking at all the melodies
          longer than 4 notes, and exploring their internal structure. You can
          also listen to all the prefixes of each melody, even if they weren't
          actually present in the dataset!
        </p>
      </section>

      <div style="position: relative">
        <svg id="svg"></svg>

        <div class="explanation">
          <div class="instructions">
            <br><br>
            Each cell is a note in one of the top 2000 melodies. Hover over them.
          </div>
          <div class="stat" hidden>
            <div id="statMelName"></div>
            <div id="percentage">61.3%</div> of the top melodies begin with this sequence of notes.
            <div id="statValue"></div>
          </div>
          <br>
          <div class="small hint" hidden>Click to expand and listen.
            Shift click on a note to zoom in, or on the inner white circle to reset.
          </div>
        </div>
      </div>
    </div>

    <div class="tooltip" id="tooltip" hidden>
      <div id="dataText">
        <b id="melName"></b>Composed across <b id="sessionsText"></b> sessions and harmonized <b id="valueText"></b> times.
      </div>
      <div id="noDataText" hidden>This melody was not in the top 2000, but you can still explore it here:</div>
      <div class="viz">
        <svg id="visualizer"></svg>
      </div>
      <div class="small status" hidden>Harmonizing takes a couple of seconds...please wait.</div>
      <div class="actions horizontal">
        <div>
          <button onclick="playMelody()" id="btnPlay">play</button>
          <button onclick="harmonize(event)" id="btnHarmonize">harmonize</button>
        </div>
        <button onclick="closeTooltip()">close</button>
      </div>

      <div id="melodyTweet">Do you think you know what this melody is?
        <a id="melodyTweetLink" target="_blank">Tweet at us</a> and we'll
          try to label it! Or, open this melody in our
          <a id="coucouLink" target="_blank">companion app</a>
          to explore more harmonizations.
      </div>
    </div>
  </body>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.8.0"></script>
  <script src="common.js"></script>
  <script src="viz.js"></script>
  <script src="sunburst.js"></script>
  <script>
    let allData, flatData, allLabels, allLabelsValues;
    const opacity = d3.scaleLinear().range(["0.1", "1.0"]).domain([120, 500]).clamp(true);

    // Don't redraw on resize on mobile since that's probably a zoom event.
    if (('ontouchstart' in window) === false) {
      window.addEventListener('resize', () => {
        sunburst();
        pixels();
        drawHits();
      });
    }

    window.onhashchange = handleForceSelect;

    // Short/long melodies.
    d3.json('data/top_overall_flat.json').then((data) => {
      flatData = data;
      pixels();
    });

    // Sunburst.
    d3.json('data/top_overall.json').then((data) => {
      allData = data;
      sunburst();
    });

    function pixels() {
      const shorts = [];
      const longs = [];

      for (let i = 0; i < flatData.length; i++) {
        flatData[i].value = flatData[i].count;
        if (flatData[i].deltas.length === 3) {
          shorts.push(flatData[i]);
        } else if (flatData[i].deltas.length >= 9) {
          longs.push(flatData[i]);
        }
      }
      // I got these deltas values by looking at the data.
      drawMelodyGrid('#short', shorts,
          [0,    1,  2,  3,  4,  5,  6,  7, 'f',  9,  10,  12, 24],
          ['f', -1, -2, -3, -4, -5, -6, -7, -8, -9, -10, -12, -24]);

      drawMelodyGrid('#long', longs,
          [0,    1,  2,  3,  4,  5,  6,  7,  9,  10,  12,  13, 17, 24],
          ['f', -1, -2, -3, -4, -5, -6, -7, -9, -10, -12, -13, 'ff', -24]
      );
    }

    function sunburst() {
      document.querySelector('#svg').innerHTML = '';
      const size = Math.min(window.innerWidth, window.innerHeight);
      drawSunburst(allData, size);

      if (!allLabels) {
        d3.json(LABELS_URL).then((labels) => {
          allLabels = labels;
          allLabelsValues = Object.values(allLabels).sort((a,b) => a.deltas.localeCompare(b.deltas));
          drawHits();
          // If there's a hash, we should try to select that melody.
          handleForceSelect();
        });
      }
    }

    function drawHits() {
       // Set up the drawing area.
      let width = Math.min(window.innerWidth, 1000);
      const x = d3.scaleBand().rangeRound([0, width]).domain(d3.range(allLabelsValues.length));
      const r =  x.bandwidth();
      const height = r + 20;

      // Set up the SVG.
      const svg = d3.select('#hits');
      svg.node().innerHTML = '';
      svg.attr('width', width)
         .attr('height', height);

      svg.append('g').selectAll('rect')
        .data(allLabelsValues)
        .enter().append('rect')
        .attr('class', 'dot')
        .attr('width', r - 1)
        .attr('height', r - 1)
        .attr('x', (d, i) => x(i))
        .attr('y', 10)
        .attr('fill', d => color(d.deltas.split(' ')[0]))
        .attr('fill-opacity', d => opacity(d.count))
        .attr('stroke', 'black')
        .attr('stroke-width', 0)
        .on('click', (d) => handleClick.call(d3.event.currentTarget,
            d3.select(`#p${d.id}`).data()[0]))
        .on('mouseover', (d) => mouseoverPixel.call(
            d3.event.currentTarget, d3.select(`#p${d.id}`).data()[0]))
        .on('mouseout', (d) => mouseoutPixel.call(d3.event.currentTarget,
            {data:d}, r));
    }

    function drawMelodyGrid(svgName, data, posDeltas, negDeltas) {
      // Set up the drawing area.
      let width = Math.min(window.innerWidth, 1000);
      const xPos = d3.scaleBand().rangeRound([0, width]).domain(posDeltas);
      const xNeg = d3.scaleBand().rangeRound([0, width]).domain(negDeltas);

      // Figure out the dot size that fits in this width.
      let r = xPos.bandwidth() / 5;

      // And how many of deltas, so that we can draw them in the right place.
      const posDeltaCounts = new Array(posDeltas.length).fill(0);
      const negDeltaCounts = new Array(negDeltas.length).fill(0);

      data.forEach(d => {
        let value;
        d.band = d.deltas[0];
        d.color = color(d.band);
        if (d.band >= 0) {
          const index = posDeltas.indexOf(d.band);
          value = posDeltaCounts[index];
          posDeltaCounts[index]++;
        } else {
          const index = negDeltas.indexOf(d.band);
          value = negDeltaCounts[index];
          negDeltaCounts[index]++;
        }
        d.x = value % 5 * r;
        d.y = (value / 5 >> 0) * r;
      });

      const posHeight = Math.max(...posDeltaCounts) / 5 * r;
      const negHeight = Math.max(...negDeltaCounts) / 5 * r;
      const height = posHeight + negHeight;

      // Set up the SVG.
      const svg = d3.select(svgName);
      svg.node().innerHTML = '';
      svg.attr('width', width)
         .attr('height', height);

      svg.append('g').selectAll('rect')
        .data(data)
        .enter()
        .append('rect')
        .attr('class', 'dot')
        .attr('x', (d) => (d.band >= 0 ? xPos(d.band) : xNeg(d.band)) + d.x)
        .attr('y', (d) => (d.band >= 0 ? height - negHeight-d.y : d.y + posHeight + r))
        .attr('width', r - 1)
        .attr('height', r - 1)
        .attr('fill', d => d.color)
        .attr('fill-opacity', d => opacity(d.count))
        .attr('stroke', 'black')
        .attr('stroke-width', 0)
        .on('click', (d) => handleClick.call(d3.event.currentTarget, {data:d}))
        .on('mouseover', (d) => mouseoverPixel.call(d3.event.currentTarget, {data:d}))
        .on('mouseout', (d) => mouseoutPixel.call(d3.event.currentTarget, {data:d}, r));
    }

    function mouseoverPixel(d) {
      d3.select(this)
        .attr('r', 10)
        .raise()
        .attr('stroke-width', 2)
        .attr('fill-opacity', 1);
      handleMouseOver.call(this, d);
    }

    function mouseoutPixel(d, r) {
      d3.select(this)
        .attr('r', r/2.2)
        .attr('fill-opacity', opacity(d.data.count))
        .attr('stroke-width', 0);
      handleMouseOut.call(this);
    }

  </script>
</html>
