<html>
  <head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.3.2/d3-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.8.0"></script>
    <script src="common.js"></script>
    <link href="style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Google+Sans:400,500&display=swap" rel="stylesheet">
  </head>
  <body>
    <header class="horizontal">
      <div>
        <a href="/index.html">Bach Doodle Dataset</a>  
      </div>
      <div class="menu">
        <a href="https://magenta.tensorflow.org/datasets">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
          Get the data
        </a>
        <a href="https://www.google.com/doodles/celebrating-johann-sebastian-bach">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>
          Play the game
        </a>
        <a href="/index.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
          Share
        </a> 
      </div>
      <div class="menu-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      </div>
    </header>
    
    <section>
      <h1>What did the doodlers <span id="textCountry"></span>compose?</h1>
      <p>
        <span class="accent purple outline">Hover</span> over any of the cells to see the melody up to that point.
        <span class="accent blue outline">Move</span> any of the labels out of the way.
        <span class="accent pink outline">Click</span> on a cell to hear what the melody sounds like.
        <span class="accent green outline">Create a harmonization</span> to see what the model might have created for
        that melody.
      </p>
      <div id="legend"></div>
    </section>
    
    <div class="center">
      <svg id="svg"></svg>
    </div>
    
    <div class="tooltip" id="tooltip" hidden>
      <p>Heard <b id="valueText"></b> times across <b>xxx</b> sessions.</p>
      <svg id="visualizer"></svg>
      <p hidden>
        <button class="accent pink" id="btnHarmonize">Harmonize! (warning: slow)</button>
      </p>
    </div>
  </body>
  <script>
    for(let i = -11; i < 0; i++) {
      const s = document.createElement('span');
      s.style.background = color(i);
      s.textContent = i;
      legend.append(s);
    }
    for(let i = 0; i < 12; i++) {
      const s = document.createElement('span');
      s.style.background = color(i);
      s.textContent = i;
      legend.append(s);
    }
    
    
    const availableCountries = ['other', 'qa', 'fi', 'fr', 'ni', 'nl', 'in', 'il', 'ie', 'is', 'iq', 'it', 'ar', 'au', 'at', 'ae', 'am', 'lb', 'tw', 'tr', 'lt', 'th', 'tn', 'sv', 'si', 'sk', 'kr', 'kw', 'sa', 'se', 'sg', 'ch', 'cl', 'co', 'ca', 'cz', 'ec', 'cr', 'ma', 've', 'vn', 'br', 'by', 'bg', 'bd', 'ba', 'bo', 'bh', 'md', 'uy', 'us', 'uk', 'ua', 'mx', 'pa', 'pe', 'eg', 'ee', 'pl', 'pr', 'ps', 'pt', 'py', 'es', 'hk', 'hn', 'hr', 'hu', 'do', 'dk', 'de', 'dz', 'ph', 'ro', 'om', 'gt', 'ru', 'rs', 'gr', 'jo', 'jp']
    
    // Is this the overall view or a per-country view?
    const search = window.location.search.split('=');
    const country = search.length > 1 ? search[1].toLowerCase() : '';
    const isCountryView = country !== '' && availableCountries.indexOf(country) !== -1;
    
    // Update the UI to match what we're looking at.
    textCountry.innerHTML = isCountryView ? `in <span class="accent yellow">${isoCountries[country]}</span> `: '';
    document.title = isCountryView ? isoCountries[country]: 'Overall' + ' repeated melodies';
    
    const size = Math.min(window.innerWidth, window.innerHeight) + 200;
    
    const specialMelodiesForOverall = [
      {id: 5117, name: 'Ode to Joy'},
      {id: 4941, name: 'Megalovania'},
      {id: 5049, name: 'Happy Birthday'},
      {id: 5033, name: 'Take on Me (A-ha)'},
      {id: 5024, name: 'All Star (Smash Mouth)'},
      {id: 4809, name: 'Star Wars Theme'},
      {id: 4955, name: 'Tetris Theme'},
      {id: 4762, name: 'Baby Shark'},
      {id: 4797, name: 'When the Saints Go Marching In'},
      {id: 4866, name: 'Super Mario Theme'}
    ];
    
    d3.json(isCountryView ? TOP_PER_COUNTRY_URL : TOP_OVERALL_URL).then((data) => {
      loadAllSamples();
      drawSunburst(isCountryView ? data[country] : data, size);
      const height = parseInt(d3.select('#svg').style('height'));
      
      if (!isCountryView) {
        const annotations = [];
        for (let i = 0; i < specialMelodiesForOverall.length; i++) {
          const obj = {};
          obj.note = {title: specialMelodiesForOverall[i].name, wrap: 300, bgPadding: 20};
          obj.connector = {end: 'dot', endScale: 4};
          
          const el = document.getElementById('p' + specialMelodiesForOverall[i].id);
          const bbox = el.getBBox();
          obj.x = bbox.x + bbox.width/2;
          obj.y = bbox.y + bbox.height/2;
          obj.dx = (obj.x < size/2) ? -50: 20;
          obj.dy = (obj.x < size/2) ? 50 : -50
          annotations.push(obj);
        }

        const makeAnnotations = d3.annotation()
          .type(d3.annotationCallout)
          .notePadding(15)
          .editMode(true)
          .annotations(annotations)

        d3.select('#svg')
          .append('g')
          .attr('class', 'annotation')
          .call(makeAnnotations)
      }

      // If there's a hash, we should try to select that melody.
      const pathIndex = window.location.hash.slice(1);
      if (pathIndex !== '') {
        handleForceSelect(pathIndex);
      }
    });
  </script>
</html>