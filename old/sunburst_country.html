<html>
  <head>
    <title>sunburst</title>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.8.0"></script>
    <link href="style.css" rel="stylesheet">
    <script src="common.js"></script>
  </head>
  <body>
    <h1 id="h1"></h1>
    slow to load, hover to inspect, click to play, <b>shift+click</b> to zoom into a slice, click on the white circle to reset.
    <br>
    <div id="legend"></div>
    <svg id="svg"></svg>
    <div class="tooltip" id="tooltip" hidden>
      <span id="seqText"></span>: <b id="valueText"></b> times<br>
      <svg id="visualizer"></svg>
    </div>
  </body>
  <script>
    const search = window.location.search.split('=');
    const country = search.length > 0 ? search[1] : 'US';
    h1.textContent = document.title = country + ' ' + isoCountries[country.toUpperCase()];
    
    
    SHOULD_RAISE = false;
    window.zoomPie = function(el) {
      el.attr('d_', el.attr('d'))
      
      const height = window.innerHeight - 300;
      const width = window.innerWidth - 100;
      const radius = Math.min(height, width) / 40;
      
      const arc = d3.arc()
        .startAngle(d => d.x0 - 10/360)
        .endAngle(d => d.x1 + 10/360)
        .padAngle(d => Math.min((d.x1 - d.x0), 0.005))
        .padRadius(radius)
        .innerRadius(d => (d.y0 * radius) - 10)
        .outerRadius(d => (Math.max(d.y0 * radius, d.y1 * radius - 1)) + 10)
      
      el
      .attr('d', arc)
      .attr('fill-opacity', 1)

      if (SHOULD_RAISE)
        el.raise();
    }
    
    d3.json('/data/top_per_country.json').then((json) => {
      loadAllSamples();
      showData(json[country]);
    });
    
    function showData(data) {
      //https://observablehq.com/@d3/zoomable-sunburst
      const height = window.innerHeight - 300;
      const width = window.innerWidth - 100;
      const radius = Math.min(height, width) / 40;
      
      const partition = data => {
        const root = d3.hierarchy(data)
            .sum(d => d.value)
            .sort((a, b) => b.value - a.value);
        return d3.partition()
            .size([2 * Math.PI, root.height + 1])
          (root);
      }
      const root = partition(data);
      root.each(d => d.current = d);
      
      const arc = d3.arc()
        .startAngle(d => d.x0)
        .endAngle(d => d.x1)
        .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
        .padRadius(radius)
        .innerRadius(d => d.y0 * radius)
        .outerRadius(d => Math.max(d.y0 * radius, d.y1 * radius - 1))
      
      const svg = d3.select('#svg')
          .style('width', '100%')
          .style('height', 'auto');

      const g = svg.append('g')
          .attr('transform', `translate(${width / 2},${width / 2})`);

      const path = g.append('g')
        .selectAll('path')
        .data(root.descendants().slice(1))
        .enter().append('path')
          .attr('fill', fill)
          .attr('fill-opacity', ZOOM_OPACITY)
          .on('click', (d,i) => {
            if (d3.event.shiftKey) {
              if (d.descendants().length > 1) {
                zoom(d,i);
              }
            } else {
              handleClick(d,i);
            }
          })
          //.attr("display", function(d) { return d.depth && d.depth > 3 ? null : "none"; }) // hide inner rings
          .on('mouseover', handleMouseOver)
          .on('mouseout', handleMouseOut)
          .attr('d', d => arc(d.current));

      // Middle white circle.
      const parent = g.append('circle')
          .datum(root)
          .attr('r', radius)
          .attr('fill', 'white')
          .attr('pointer-events', 'all')
          .on('click', zoom);

      function zoom(p) {
        //parent.datum(p.parent || root);

        root.each(d => d.target = {
          x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
          x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
          y0: Math.max(0, d.y0 - p.depth),
          y1: Math.max(0, d.y1 - p.depth)
        });

        const t = g.transition().duration(250);

        // Transition the data on all arcs, even the ones that arenâ€™t visible,
        // so that if this transition is interrupted, entering arcs will start
        // the next transition from the desired position.
        path.transition(t)
          .tween('data', d => {
            const i = d3.interpolate(d.current, d.target);
            return t => d.current = i(t);
          })
          .attr('fill-opacity', ZOOM_OPACITY)
          .attrTween('d', d => () => arc(d.current));
      }
      
      svg.node();
      const el = document.getElementById('svg');
      const box = el.getBBox();
      el.setAttribute('viewBox', `${box.x} ${box.y} ${box.width} ${box.height}`);  
    }
  </script>
</html>