<html>
  <head>
    <title>all-sunburst</title>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.8.0"></script>
    <script src="./common.js"></script>
    <link href="style.css" rel="stylesheet">
    <style>
      #container svg {
        border: 2px solid black;
        border-radius: 50%;
      }
      circle {
        fill: none;
        stroke: black;
        stroke-width: 2;
      }
    </style>
  </head>
  <body>
    very very slow to load, hover to inspect, click to expand as sunburst, shift+click to expand as grid.<br>
    the size scale is the number of total sequences for that country.
    <div id="legend"></div>
    <svg width="960" height="960">
      <g class="base" transform="translate(480,480)"></g>
    </svg>
  </body>
  <script>
    const countrySizes = [["us", 6581.192], ["br", 1541.549], ["mx", 1057.061], ["it", 893.475], ["es", 838.7], ["tr", 834.65], ["ru", 772.695], ["uk", 673.99], ["co", 564.413], ["ua", 538.132], ["de", 524.415], ["in", 514.552], ["tw", 467.485], ["ca", 446.992], ["ar", 414.802], ["fr", 407.252], ["pl", 283.701], ["nl", 277.014], ["jp", 274.463], ["vn", 270.068], ["pe", 223.066], ["cl", 219.882], ["ro", 187.22], ["ve", 165.243], ["pt", 156.389], ["hk", 133.441], ["cz", 118.685], ["kr", 117.294], ["ec", 115.863], ["hu", 111.459], ["th", 110.246], ["gr", 109.671], ["se", 91.388], ["ch", 86.99], ["dk", 84.954], ["fi", 73.833], ["by", 71.752], ["il", 71.359], ["gt", 67.469], ["rs", 67.358], ["sk", 63.443], ["at", 61.128], ["hr", 57.219], ["eg", 53.589], ["ie", 52.418], ["cr", 51.58], ["sg", 49.332], ["uy", 45.725], ["sa", 45.028], ["do", 42.835], ["bo", 41.072], ["lt", 36.976], ["si", 35.197], ["sv", 34.254], ["bg", 33.808], ["ae", 33.594], ["pa", 29.171], ["py", 27.509], ["hn", 26.464], ["md", 25.587], ["dz", 24.657], ["bd", 23.013], ["am", 20.805], ["ee", 19.959], ["ba", 18.385], ["pr", 16.605], ["ma", 16.451], ["ni", 13.542], ["tn", 12.575], ["au", 11.741], ["iq", 1], ["jo", 1], ["lb", 1], ["other", 1], ["qa", 1], ["om", 1], ["kw", 1], ["ps", 1], ["is", 1], ["be", 1], ["bh", 1], ["nz", 1], ["id", 1], ["ph", 1], ["no", 1], ["my", 1], ["ly", 1], ["ir", 1], ["za", 1], ["kz", 1], ["lv", 1], ["cy", 1], ["as", 1], ["pk", 1], ["mt", 1], ["lk", 1], ["ge", 1], ["lu", 1], ["mm", 1], ["az", 1], ["uz", 1], ["np", 1], ["mk", 1], ["kg", 1], ["tt", 1], ["jm", 1], ["ng", 1], ["ke", 1], ["je", 1]]
    const minSize = 0.1;
    const maxSize = 6500;
    const sizeScale = d3.scaleSqrt().domain([minSize, maxSize]).range([14, 160]);
    console.log('starting to download....')
    d3.json('/data/top_per_country.json').then(showData);
    let allData;
    
    function showData(json) {
      console.log('done downloading, starting to render....')
      allData = json;
      
      const svg = d3.select('svg');
      const circles = d3.packSiblings(
        d3.range(countrySizes.length)
        .map((d,i) => {
          const country = countrySizes[i][0];
          return {
            r: sizeScale(countrySizes[i][1]), 
            country: country,
            data: json[country]
          }
        })
        .filter((d) => d.data.children.length > 0));
      
        // Add a circle for each country.
        svg
        .select('g')
        .selectAll('circle')
        .data(circles)
        .enter().append('circle')
          .attr('cx', (d) => d.x)
          .attr('cy', (d) => d.y)
          .attr('r', (d) => d.r)
          .attr('id', (d) => d.country)
          .each((d) => {
            console.log('rendering', d.country)
             displaySunburst(d.data, d.country, d.r, d.x, d.y);
          });
    }
    
    function displaySunburst(data, country, radius, x, y) {
      const origRadius = radius;
      radius = origRadius * 2;
      
      //https://observablehq.com/@d3/sunburst
      const partition = data => d3.partition()
        .size([2 * Math.PI, radius])
      (d3.hierarchy(data)
        .sum(d => d.value)
        .sort((a, b) => b.value - a.value))
      const root = partition(data);

      const arc = d3.arc()
        .startAngle(d => d.x0)
        .endAngle(d => d.x1)
        .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))      
        .padRadius(origRadius)
        .innerRadius(d => Math.min(d.y0, origRadius))
        .outerRadius(d => Math.min(d.y1, origRadius))
            
      const svg = d3.select('.base')
        .append('g')
        .attr('transform', `translate(${x},${y})`)  
        .on('click', (d) => {
            if (d3.event.shiftKey) {
              window.open('grid_country.html?country=' + country, '_blank');
            } else {
              window.open('sunburst_country.html?country=' + country, '_blank');
            }
          })
        
      svg.selectAll('path')
          .data(root.descendants().filter(d => d.depth))
          .enter().append('path')
          .attr('fill', fill)
          .attr('fill-opacity', 1)
          .attr('d', arc)
          //.attr('transform', (d) => `translate(${radius},${radius})`)
          
      svg.node();
      const el = document.getElementById(country);
      const box = el.getBBox();
      el.setAttribute('viewBox', `${box.x} ${box.y} ${radius * 2} ${radius * 2}`); 
    }
    
    
  </script>
</html>


