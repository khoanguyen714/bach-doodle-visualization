<html>
  <head>
    <title>all-sunburst</title>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.8.0"></script>
    <script src="common.js"></script>
    <link href="style.css" rel="stylesheet">
    <style>
      #container svg {
        border: 2px solid black;
        border-radius: 50%;
      }
    </style>
  </head>
  <body>
    very very slow to load, hover to inspect, click to expand as sunburst, shift+click to expand as grid.<br>
    the size scale is the number of total sequences for that country.
    <div id="legend"></div>
    <div id="container"></div>
  </body>
  <script>
    const countrySizes = [["je", 1], ["ke", 1], ["ng", 1], ["jm", 1], ["tt", 1], ["kg", 1], ["mk", 1], ["np", 1], ["uz", 1], ["az", 1], ["mm", 1], ["lu", 1], ["ge", 1], ["lk", 1], ["mt", 1], ["pk", 1], ["as", 1], ["cy", 1], ["lv", 1], ["kz", 1], ["za", 1], ["ir", 1], ["ly", 1], ["my", 1], ["no", 1], ["ph", 1], ["id", 1], ["nz", 1], ["bh", 1], ["be", 1], ["is", 1], ["ps", 1], ["kw", 1], ["om", 1], ["qa", 1], ["other", 1], ["lb", 1], ["jo", 1], ["iq", 1], ["au", 11.741], ["tn", 12.575], ["ni", 13.542], ["ma", 16.451], ["pr", 16.605], ["ba", 18.385], ["ee", 19.959], ["am", 20.805], ["bd", 23.013], ["dz", 24.657], ["md", 25.587], ["hn", 26.464], ["py", 27.509], ["pa", 29.171], ["ae", 33.594], ["bg", 33.808], ["sv", 34.254], ["si", 35.197], ["lt", 36.976], ["bo", 41.072], ["do", 42.835], ["sa", 45.028], ["uy", 45.725], ["sg", 49.332], ["cr", 51.58], ["ie", 52.418], ["eg", 53.589], ["hr", 57.219], ["at", 61.128], ["sk", 63.443], ["rs", 67.358], ["gt", 67.469], ["il", 71.359], ["by", 71.752], ["fi", 73.833], ["dk", 84.954], ["ch", 86.99], ["se", 91.388], ["gr", 109.671], ["th", 110.246], ["hu", 111.459], ["ec", 115.863], ["kr", 117.294], ["cz", 118.685], ["hk", 133.441], ["pt", 156.389], ["ve", 165.243], ["ro", 187.22], ["cl", 219.882], ["pe", 223.066], ["vn", 270.068], ["jp", 274.463], ["nl", 277.014], ["pl", 283.701], ["fr", 407.252], ["ar", 414.802], ["ca", 446.992], ["tw", 467.485], ["in", 514.552], ["de", 524.415], ["ua", 538.132], ["co", 564.413], ["uk", 673.99], ["ru", 772.695], ["tr", 834.65], ["es", 838.7], ["it", 893.475], ["mx", 1057.061], ["br", 1541.549], ["us", 6581.192]]
    const minSize = 0.1;
    const maxSize = 6500;
    const sizeScale = d3.scaleLog().domain([minSize, maxSize]).range([10, 180]);
    
    d3.json('/data/top_per_country.json').then(showData);
    let allData;
    
    function showData(json) {
      allData = json;
      
      for (let i = 0; i < countrySizes.length; i++) {
        const country = countrySizes[i][0];
        if (json[country].children.length > 0) {
          const size = sizeScale(countrySizes[i][1]);
          displaySunburst(json[country], country, size, size);
        }
      }
    }
    
    function displaySunburst(data, country, width, height) {
      if (data.children.length === 0) {
        return;
      }
      
      //https://observablehq.com/@d3/sunburst
      const radius = width / 1.3;  // smaller than normal so that they're bigger.
      
      const partition = data => d3.partition()
        .size([2 * Math.PI, radius])
      (d3.hierarchy(data)
        .sum(d => d.value)
        .sort((a, b) => b.value - a.value))
      const root = partition(data);

      const arc = d3.arc()
        .startAngle(d => d.x0)
        .endAngle(d => d.x1)
        .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
        .padRadius(radius / 2)
        .innerRadius(d => d.y0)
        .outerRadius(d => d.y1 - 1)
            
      const svg = d3.select('#container').append('svg')
        .attr('id', country)
        .style('width', width)
        .style('height', height)
        .attr('title', country)
        .property('r', width)
        .on('click', () => {
          if (d3.event.shiftKey) {
            window.open('grid_country.html?country=' + country, '_blank');
          } else {
            window.open('sunburst_country.html?country=' + country, '_blank');
          }
        });
      
      svg.append('g')
          .selectAll('path')
          .data(root.descendants().filter(d => d.depth))
          .enter().append('path')
          .attr('fill', fill)
          .attr('fill-opacity', 1)
          .attr('d', arc)
          .attr('transform', (d) => `translate(${width/2},${height/2})`)
      
      svg.node();
      // const el = document.getElementById(country);
      // const box = el.getBBox();
      // el.setAttribute('viewBox', `${box.x} ${box.y} ${box.width} ${box.height}`); 
    }
  </script>
</html>


